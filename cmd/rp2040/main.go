package main

import (
	"context"
	"machine"
	"time"

	"github.com/pmcanseco/go-sat-tracker/internal/display"
	tinyGPS "github.com/pmcanseco/go-sat-tracker/internal/gps"
	"github.com/pmcanseco/go-sat-tracker/internal/motors"
	"github.com/pmcanseco/go-sat-tracker/internal/steppermotor"
	tinyTime "github.com/pmcanseco/go-sat-tracker/internal/time"
	"github.com/pmcanseco/go-sat-tracker/internal/tracking"
	"tinygo.org/x/drivers/gps"
	"tinygo.org/x/drivers/ssd1306"
)

//var (
//	npRed    = []color.RGBA{{255, 0, 0, 96}}
//	npOrange = []color.RGBA{{255, 140, 0, 96}}
//	npYellow = []color.RGBA{{255, 255, 0, 96}}
//	npGreen  = []color.RGBA{{0, 255, 0, 96}}
//	npBlue   = []color.RGBA{{0, 0, 255, 96}}
//	npPink   = []color.RGBA{{255, 0, 255, 96}}
//)

const (
	GPSPin                = machine.GPIO9 // WIRING - WHITE GPS WIRE GOES HERE
	NeoPixelPin           = machine.GPIO16
	ElevationSleepPin     = machine.GPIO8  // WIRING - Pin 6 white (immediately below pins 10 and 9)
	ElevationStepPin      = machine.GPIO7  // WIRING - Pin 5 green
	ElevationDirectionPin = machine.GPIO10 // WIRING - blue
	AzimuthSleepPin       = machine.GPIO26 // WIRING - A0 white
	AzimuthStepPin        = machine.GPIO27 // WIRING - A1 green
	AzimuthDirectionPin   = machine.GPIO28 // WIRING - A2 blue
)

func main() {
	//NeoPixelPin.Configure(machine.PinConfig{Mode: machine.PinOutput})
	//neopixel := ws2812.New(machine.GPIO16)
	//_ = neopixel.WriteColors([]color.RGBA{{0, 0, 0, 255}})

	led := machine.LED
	led.Configure(machine.PinConfig{Mode: machine.PinOutput})
	led.High()
	time.Sleep(500 * time.Millisecond)
	led.Low()
	time.Sleep(500 * time.Millisecond)
	led.High()
	time.Sleep(500 * time.Millisecond)
	led.Low()
	time.Sleep(500 * time.Millisecond)
	led.High()
	time.Sleep(500 * time.Millisecond)

	println("BOOTING")
	for i := 0; i < 5; i++ {
		print(".")
		time.Sleep(3 * time.Second)
	}

	println("\n\n\nhello world!!!")

	//defer func() {
	//	if r := recover(); r != nil {
	//		println("panicked!")
	//	}
	//}()

	time.Sleep(1 * time.Second)

	//sat := satellite.NewSatellite(
	//	"1 25544U 98067A   23071.22950734  .00021411  00000-0  39277-3 0  9995",
	//	"2 25544  51.6409  88.8414 0005771  75.2083  23.5161 15.49204123386753",
	//	gosat.GravityWGS84)
	//println("MADE SATELLITE!")

	//i2c := machine.I2C1
	//err := i2c.Configure(machine.I2CConfig{
	//	Frequency: 400 * machine.KHz,
	//	SDA:       machine.I2C1_SDA_PIN,
	//	SCL:       machine.I2C1_SCL_PIN,
	//})
	//if err != nil {
	//	_ = neopixel.WriteColors(npRed)
	//}

	//oled := ssd1306.NewI2C(i2c)
	//oled.Configure(ssd1306.Config{
	//	Address: 0x3C,
	//	Width:   128,
	//	Height:  32,
	//})
	//oled.ClearDisplay()

	//d := getDevice(oled)
	//wipeAnimation := display.NewWipeAnimation(d)
	//wipeAnimation.Run()

	//screen := display.NewFontDisplay(d, 128, 32, display.Consolas7pt)

	//screen.Print("IDLE")
	//time.Sleep(1 * time.Second)
	//screen.Print("WAITPASS")
	//time.Sleep(1 * time.Second)
	//screen.Print("TRACK AZ:150 EL:30")
	//time.Sleep(1 * time.Second)
	//screen.Print("TRACKING COMPLETE")
	//time.Sleep(1 * time.Second)

	_ = machine.UART1.Configure(machine.UARTConfig{
		BaudRate: 9600,
		RX:       GPSPin,
	})

	ublox := gps.NewUART(machine.UART1)
	gpsDevice := tinyGPS.New(func() (string, error) {
		s, err := ublox.NextSentence()
		//println(s)
		return s, err
	})

	println("GETTING FIX")

	//gps.SetDebug(screen.Print)
	gpsDevice.GetFix()
	println("GOT FIX!")
	gpsDevice.SetDebug(nil)
	now, _, lat, lon, alt := gpsDevice.GetCoordinates()
	println("GOT COORDS! Lat: ", lat, "\tLon: ", lon, "\t Alt: ", alt)
	for alt == 0 && now.Year() != 1 {
		now, _, lat, lon, alt = gpsDevice.GetCoordinates()
		println("GOT COORDS! Lat: ", lat, "\tLon: ", lon, "\t Alt: ", alt)
		time.Sleep(300 * time.Millisecond)
	}
	now = gpsDevice.Time()
	gpsDevice.Quit()
	time.Sleep(2 * time.Second)
	tinyTime.SetTime(now)
	println("SET TIME! ", tinyTime.GetTime().Format(time.RFC822))
	elMotor := getElevationMotor()
	println("MADE ELEV MOTOR!")
	azMotor := getAzimuthMotor()
	println("MADE AZIMUTH MOTOR!")

	//tracker := tracking.NewTracker(
	//	sat,
	//	satellite.Coordinates{
	//		LatitudeDegrees:  float64(lat),
	//		LongitudeDegrees: float64(lon),
	//		AltitudeKM:       float64(alt / 1000),
	//	})
	tracker := tracking.NewTrackerWithPlan(
		[]byte(
			`{"Passes":[{"StartTime":"2023-07-08T23:58:51.3947444Z","StartLookAngles":{"az":256.9990191639354,"el":20.01330430482635},"MidTime":"2023-07-09T00:00:50.3947444Z","MidLookAngles":{"az":326.8769684584309,"el":49.47493444314693},"EndTime":"2023-07-09T00:02:48.3947444Z","EndLookAngles":{"az":35.62627569916181,"el":19.93335870200949},"FullPath":[{"Time":"2023-07-08T23:58:51.3947444Z","az":256.9990191639354,"el":20.01330430482635},{"Time":"2023-07-08T23:58:52.3947444Z","az":257.16658011617983,"el":20.199123325943948},{"Time":"2023-07-08T23:58:53.3947444Z","az":257.3365792333314,"el":20.386669913551994},{"Time":"2023-07-08T23:58:54.3947444Z","az":257.50906844227137,"el":20.575966332894055},{"Time":"2023-07-08T23:58:55.3947444Z","az":257.6841081578375,"el":20.767042723118358},{"Time":"2023-07-08T23:58:56.3947444Z","az":257.8617390554911,"el":20.959906265279017},{"Time":"2023-07-08T23:58:57.3947444Z","az":258.04202436572837,"el":21.1545872925846},{"Time":"2023-07-08T23:58:58.3947444Z","az":258.22502185647784,"el":21.351108599764668},{"Time":"2023-07-08T23:58:59.3947444Z","az":258.410790871542,"el":21.54949307994062},{"Time":"2023-07-08T23:59:00.3947444Z","az":258.5993923797399,"el":21.74976370836241},{"Time":"2023-07-08T23:59:01.3947444Z","az":258.79088902590985,"el":21.951943525136116},{"Time":"2023-07-08T23:59:02.3947444Z","az":258.9853451833895,"el":22.156055616296726},{"Time":"2023-07-08T23:59:03.3947444Z","az":259.1828350154124,"el":22.362131423853064},{"Time":"2023-07-08T23:59:04.3947444Z","az":259.3834106283637,"el":22.57017748203721},{"Time":"2023-07-08T23:59:05.3947444Z","az":259.58714979761277,"el":22.78022513692297},{"Time":"2023-07-08T23:59:06.3947444Z","az":259.79412437057,"el":22.992297437450624},{"Time":"2023-07-08T23:59:07.3947444Z","az":260.0044082121091,"el":23.206417359124547},{"Time":"2023-07-08T23:59:08.3947444Z","az":260.21807726796493,"el":23.42260777444547},{"Time":"2023-07-08T23:59:09.3947444Z","az":260.43520963002,"el":23.640891421121424},{"Time":"2023-07-08T23:59:10.3947444Z","az":260.65589455454705,"el":23.861299778239804},{"Time":"2023-07-08T23:59:11.3947444Z","az":260.8801968753279,"el":24.08383747500656},{"Time":"2023-07-08T23:59:12.3947444Z","az":261.10821034140343,"el":24.30853545488413},{"Time":"2023-07-08T23:59:13.3947444Z","az":261.3400223225682,"el":24.535415550011336},{"Time":"2023-07-08T23:59:14.3947444Z","az":261.57572269175563,"el":24.76449926126749},{"Time":"2023-07-08T23:59:15.3947444Z","az":261.8154039026761,"el":24.99580771040048},{"Time":"2023-07-08T23:59:16.3947444Z","az":262.0591610695791,"el":25.229361588867565},{"Time":"2023-07-08T23:59:17.3947444Z","az":262.30710210958495,"el":25.46519063698683},{"Time":"2023-07-08T23:59:18.3947444Z","az":262.5593077592865,"el":25.70329554365161},{"Time":"2023-07-08T23:59:19.3947444Z","az":262.81589150533296,"el":25.943704809937547},{"Time":"2023-07-08T23:59:20.3947444Z","az":263.07695994506594,"el":26.18643682420101},{"Time":"2023-07-08T23:59:21.3947444Z","az":263.3426227672767,"el":26.43150923397671},{"Time":"2023-07-08T23:59:22.3947444Z","az":263.61299284468424,"el":26.678938871468105},{"Time":"2023-07-08T23:59:23.3947444Z","az":263.88818632831317,"el":26.92874167435763},{"Time":"2023-07-08T23:59:24.3947444Z","az":264.1683227437975,"el":27.180932601730593},{"Time":"2023-07-08T23:59:25.3947444Z","az":264.4535366676955,"el":27.435535836490033},{"Time":"2023-07-08T23:59:26.3947444Z","az":264.74393172571735,"el":27.692543621563278},{"Time":"2023-07-08T23:59:27.3947444Z","az":265.039649534536,"el":27.95197761791663},{"Time":"2023-07-08T23:59:28.3947444Z","az":265.3408241152359,"el":28.21384792290302},{"Time":"2023-07-08T23:59:29.3947444Z","az":265.6475933694101,"el":28.47816315296236},{"Time":"2023-07-08T23:59:30.3947444Z","az":265.9600991836823,"el":28.744930324615435},{"Time":"2023-07-08T23:59:31.3947444Z","az":266.27848753558305,"el":29.01415472935997},{"Time":"2023-07-08T23:59:32.3947444Z","az":266.6029217750708,"el":29.28585078120134},{"Time":"2023-07-08T23:59:33.3947444Z","az":266.9335302791247,"el":29.559998055057232},{"Time":"2023-07-08T23:59:34.3947444Z","az":267.27048486289823,"el":29.836606723838933},{"Time":"2023-07-08T23:59:35.3947444Z","az":267.6139489245457,"el":30.11567377956491},{"Time":"2023-07-08T23:59:36.3947444Z","az":267.96409047857065,"el":30.397193751182808},{"Time":"2023-07-08T23:59:37.3947444Z","az":268.3210822575928,"el":30.681158533114814},{"Time":"2023-07-08T23:59:38.3947444Z","az":268.6851018111878,"el":30.967557204862153},{"Time":"2023-07-08T23:59:39.3947444Z","az":269.05633160174926,"el":31.2563758419185},{"Time":"2023-07-08T23:59:40.3947444Z","az":269.4349744808132,"el":31.547609082247444},{"Time":"2023-07-08T23:59:41.3947444Z","az":269.8211925456146,"el":31.841212954448075},{"Time":"2023-07-08T23:59:42.3947444Z","az":270.21519860873985,"el":32.13717496260668},{"Time":"2023-07-08T23:59:43.3947444Z","az":270.6171956442633,"el":32.435467087939195},{"Time":"2023-07-08T23:59:44.3947444Z","az":271.027391935707,"el":32.7360572203183},{"Time":"2023-07-08T23:59:45.3947444Z","az":271.44600113140507,"el":33.03890891167771},{"Time":"2023-07-08T23:59:46.3947444Z","az":271.87324228789265,"el":33.343981118969786},{"Time":"2023-07-08T23:59:47.3947444Z","az":272.3093576274463,"el":33.65124034198171},{"Time":"2023-07-08T23:59:48.3947444Z","az":272.7545420163551,"el":33.960610812240745},{"Time":"2023-07-08T23:59:49.3947444Z","az":273.20904822345267,"el":34.272048378602754},{"Time":"2023-07-08T23:59:50.3947444Z","az":273.67311708400075,"el":34.585490850069554},{"Time":"2023-07-08T23:59:51.3947444Z","az":274.14699482290337,"el":34.90087000794596},{"Time":"2023-07-08T23:59:52.3947444Z","az":274.63093298814863,"el":35.21811129127474},{"Time":"2023-07-08T23:59:53.3947444Z","az":275.12518835648524,"el":35.53713347349231},{"Time":"2023-07-08T23:59:54.3947444Z","az":275.6300228089253,"el":35.85784833142532},{"Time":"2023-07-08T23:59:55.3947444Z","az":276.14572414165264,"el":36.18017330551552},{"Time":"2023-07-08T23:59:56.3947444Z","az":276.672522445327,"el":36.50397921945858},{"Time":"2023-07-08T23:59:57.3947444Z","az":277.21071433663116,"el":36.829167743080504},{"Time":"2023-07-08T23:59:58.3947444Z","az":277.76058013390997,"el":37.15561922774199},{"Time":"2023-07-08T23:59:59.3947444Z","az":278.3224040513273,"el":37.48320528665552},{"Time":"2023-07-09T00:00:00.3947444Z","az":278.89647381081994,"el":37.81178843836456},{"Time":"2023-07-09T00:00:01.3947444Z","az":279.4830801937458,"el":38.14122175116339},{"Time":"2023-07-09T00:00:02.3947444Z","az":280.082540906835,"el":38.471361784688916},{"Time":"2023-07-09T00:00:03.3947444Z","az":280.6951030146853,"el":38.80201508581007},{"Time":"2023-07-09T00:00:04.3947444Z","az":281.321086965139,"el":39.13301755307462},{"Time":"2023-07-09T00:00:05.3947444Z","az":281.960789907013,"el":39.46418100188476},{"Time":"2023-07-09T00:00:06.3947444Z","az":282.61450871617046,"el":39.795306121752674},{"Time":"2023-07-09T00:00:07.3947444Z","az":283.28253906986214,"el":40.12618218259812},{"Time":"2023-07-09T00:00:08.3947444Z","az":283.96517442095086,"el":40.456586763461885},{"Time":"2023-07-09T00:00:09.3947444Z","az":284.6627332329334,"el":40.78629875509755},{"Time":"2023-07-09T00:00:10.3947444Z","az":285.3754448826918,"el":41.115045113671414},{"Time":"2023-07-09T00:00:11.3947444Z","az":286.10361666599607,"el":41.44258028791278},{"Time":"2023-07-09T00:00:12.3947444Z","az":286.84752067123816,"el":41.76863298470168},{"Time":"2023-07-09T00:00:13.3947444Z","az":287.6074199329828,"el":42.092919362011564},{"Time":"2023-07-09T00:00:14.3947444Z","az":288.38356669413923,"el":42.415142994675634},{"Time":"2023-07-09T00:00:15.3947444Z","az":289.17620053638404,"el":42.73499489953857},{"Time":"2023-07-09T00:00:16.3947444Z","az":289.9855463799047,"el":43.05215362735526},{"Time":"2023-07-09T00:00:17.3947444Z","az":290.8118459372817,"el":43.36629800003367},{"Time":"2023-07-09T00:00:18.3947444Z","az":291.65522180083553,"el":43.677056920035106},{"Time":"2023-07-09T00:00:19.3947444Z","az":292.5158745083179,"el":43.984085552975934},{"Time":"2023-07-09T00:00:20.3947444Z","az":293.39394776169786,"el":44.28701505972794},{"Time":"2023-07-09T00:00:21.3947444Z","az":294.28955872596737,"el":44.58546582176821},{"Time":"2023-07-09T00:00:22.3947444Z","az":295.2027953341385,"el":44.8790480706038},{"Time":"2023-07-09T00:00:23.3947444Z","az":296.13371351889083,"el":45.167362629363595},{"Time":"2023-07-09T00:00:24.3947444Z","az":297.08237291072084,"el":45.450013022415035},{"Time":"2023-07-09T00:00:25.3947444Z","az":298.0486806074924,"el":45.726561194244745},{"Time":"2023-07-09T00:00:26.3947444Z","az":299.0326173180004,"el":45.996596867329465},{"Time":"2023-07-09T00:00:27.3947444Z","az":300.0340825861117,"el":46.259693038709706},{"Time":"2023-07-09T00:00:28.3947444Z","az":301.05292984509333,"el":46.51541882617095},{"Time":"2023-07-09T00:00:29.3947444Z","az":302.08896376855006,"el":46.76334095210537},{"Time":"2023-07-09T00:00:30.3947444Z","az":303.141937772642,"el":47.003025351141446},{"Time":"2023-07-09T00:00:31.3947444Z","az":304.2115517161039,"el":47.23403889668937},{"Time":"2023-07-09T00:00:32.3947444Z","az":305.29749385766894,"el":47.455959978843495},{"Time":"2023-07-09T00:00:33.3947444Z","az":306.39926368281874,"el":47.66834509622521},{"Time":"2023-07-09T00:00:34.3947444Z","az":307.5164326555909,"el":47.87078448382169},{"Time":"2023-07-09T00:00:35.3947444Z","az":308.64846908899307,"el":48.06286812350974},{"Time":"2023-07-09T00:00:36.3947444Z","az":309.7947809461456,"el":48.24419702873365},{"Time":"2023-07-09T00:00:37.3947444Z","az":310.9547157699062,"el":48.41438545687777},{"Time":"2023-07-09T00:00:38.3947444Z","az":312.12756114596345,"el":48.57306314259652},{"Time":"2023-07-09T00:00:39.3947444Z","az":313.3125936414781,"el":48.71988319244995},{"Time":"2023-07-09T00:00:40.3947444Z","az":314.50888922942556,"el":48.85450113745358},{"Time":"2023-07-09T00:00:41.3947444Z","az":315.7156116277276,"el":48.97661254539854},{"Time":"2023-07-09T00:00:42.3947444Z","az":316.93182489749654,"el":49.08593097162212},{"Time":"2023-07-09T00:00:43.3947444Z","az":318.1565443416219,"el":49.182196071262375},{"Time":"2023-07-09T00:00:44.3947444Z","az":319.3887405615905,"el":49.26517542994639},{"Time":"2023-07-09T00:00:45.3947444Z","az":320.6273440773409,"el":49.33466623443503},{"Time":"2023-07-09T00:00:46.3947444Z","az":321.87130060669494,"el":49.390498728177135},{"Time":"2023-07-09T00:00:47.3947444Z","az":323.1193762643179,"el":49.432529054789164},{"Time":"2023-07-09T00:00:48.3947444Z","az":324.37046391594083,"el":49.46065379587922},{"Time":"2023-07-09T00:00:49.3947444Z","az":325.6233894832651,"el":49.474801237371985},{"Time":"2023-07-09T00:00:50.3947444Z","az":326.8769684584309,"el":49.47493444314693},{"Time":"2023-07-09T00:00:51.3947444Z","az":328.13001261980304,"el":49.461051541066375},{"Time":"2023-07-09T00:00:52.3947444Z","az":329.381336799768,"el":49.43318573867218},{"Time":"2023-07-09T00:00:53.3947444Z","az":330.62976560969145,"el":49.391405068360655},{"Time":"2023-07-09T00:00:54.3947444Z","az":331.8741899944803,"el":49.33580935328927},{"Time":"2023-07-09T00:00:55.3947444Z","az":333.1133734845192,"el":49.26653893263015},{"Time":"2023-07-09T00:00:56.3947444Z","az":334.3462586970565,"el":49.18376020866314},{"Time":"2023-07-09T00:00:57.3947444Z","az":335.5717725079508,"el":49.08767278976338},{"Time":"2023-07-09T00:00:58.3947444Z","az":336.7888813946211,"el":48.97850606768639},{"Time":"2023-07-09T00:00:59.3947444Z","az":337.9965961092978,"el":48.85651756714517},{"Time":"2023-07-09T00:01:00.3947444Z","az":339.19397579265143,"el":48.72199113235902},{"Time":"2023-07-09T00:01:01.3947444Z","az":340.38017897928427,"el":48.57522883071439},{"Time":"2023-07-09T00:01:02.3947444Z","az":341.55427606500496,"el":48.41657300507301},{"Time":"2023-07-09T00:01:03.3947444Z","az":342.71553798869957,"el":48.24636868340328},{"Time":"2023-07-09T00:01:04.3947444Z","az":343.86324653014543,"el":48.06498452035642},{"Time":"2023-07-09T00:01:05.3947444Z","az":344.9967433516047,"el":47.87280490735251},{"Time":"2023-07-09T00:01:06.3947444Z","az":346.11543051429584,"el":47.67022773836134},{"Time":"2023-07-09T00:01:07.3947444Z","az":347.2187704584453,"el":47.45766219384205},{"Time":"2023-07-09T00:01:08.3947444Z","az":348.3062854868463,"el":47.23552656417357},{"Time":"2023-07-09T00:01:09.3947444Z","az":349.3775995648616,"el":47.00423664842657},{"Time":"2023-07-09T00:01:10.3947444Z","az":350.4322651982561,"el":46.76424130335486},{"Time":"2023-07-09T00:01:11.3947444Z","az":351.47002033443727,"el":46.51596463337987},{"Time":"2023-07-09T00:01:12.3947444Z","az":352.49061326054886,"el":46.259841012060434},{"Time":"2023-07-09T00:01:13.3947444Z","az":353.4938437550163,"el":45.99630421764886},{"Time":"2023-07-09T00:01:14.3947444Z","az":354.47956060686505,"el":45.725785810909414},{"Time":"2023-07-09T00:01:15.3947444Z","az":355.44765897998263,"el":45.448713635991886},{"Time":"2023-07-09T00:01:16.3947444Z","az":356.3981155477666,"el":45.16549893556612},{"Time":"2023-07-09T00:01:17.3947444Z","az":357.3308334332839,"el":44.87658093107557},{"Time":"2023-07-09T00:01:18.3947444Z","az":358.24586878823953,"el":44.58235731330649},{"Time":"2023-07-09T00:01:19.3947444Z","az":359.14327427156337,"el":44.28322859789675},{"Time":"2023-07-09T00:01:20.3947444Z","az":0.023134816336094616,"el":43.97958597895256},{"Time":"2023-07-09T00:01:21.3947444Z","az":0.8855648546137549,"el":43.67181057364256},{"Time":"2023-07-09T00:01:22.3947444Z","az":1.7307056147812574,"el":43.36027277922931},{"Time":"2023-07-09T00:01:23.3947444Z","az":2.5587225091557713,"el":43.045331736657374},{"Time":"2023-07-09T00:01:24.3947444Z","az":3.3698349191403825,"el":42.72732204394256},{"Time":"2023-07-09T00:01:25.3947444Z","az":4.164183954869926,"el":42.40660471541847},{"Time":"2023-07-09T00:01:26.3947444Z","az":4.942025965356531,"el":42.083490142536434},{"Time":"2023-07-09T00:01:27.3947444Z","az":5.70359919161845,"el":41.75828898953621},{"Time":"2023-07-09T00:01:28.3947444Z","az":6.449154725578936,"el":41.43129935802227},{"Time":"2023-07-09T00:01:29.3947444Z","az":7.178954627132765,"el":41.102806754148965},{"Time":"2023-07-09T00:01:30.3947444Z","az":7.893270174294599,"el":40.77308411561043},{"Time":"2023-07-09T00:01:31.3947444Z","az":8.592408066467547,"el":40.44237857253192},{"Time":"2023-07-09T00:01:32.3947444Z","az":9.276597033639376,"el":40.11096483672674},{"Time":"2023-07-09T00:01:33.3947444Z","az":9.946155211117686,"el":39.779065529924985},{"Time":"2023-07-09T00:01:34.3947444Z","az":10.60137577581013,"el":39.44690458535177},{"Time":"2023-07-09T00:01:35.3947444Z","az":11.24255423482772,"el":39.11469420194101},{"Time":"2023-07-09T00:01:36.3947444Z","az":11.86998738951764,"el":38.78263511273877},{"Time":"2023-07-09T00:01:37.3947444Z","az":12.483972400260356,"el":38.450916876298194},{"Time":"2023-07-09T00:01:38.3947444Z","az":13.08482985916682,"el":38.119704874419654},{"Time":"2023-07-09T00:01:39.3947444Z","az":13.672806875967536,"el":37.78919391822219},{"Time":"2023-07-09T00:01:40.3947444Z","az":14.248221432650892,"el":37.45952862396853},{"Time":"2023-07-09T00:01:41.3947444Z","az":14.811364582862335,"el":37.13085708894363},{"Time":"2023-07-09T00:01:42.3947444Z","az":15.362524367926444,"el":36.803317906564985},{"Time":"2023-07-09T00:01:43.3947444Z","az":15.90198536250593,"el":36.47704052195753},{"Time":"2023-07-09T00:01:44.3947444Z","az":16.430028280864313,"el":36.15214558882022},{"Time":"2023-07-09T00:01:45.3947444Z","az":16.946929638220166,"el":35.82874532597125},{"Time":"2023-07-09T00:01:46.3947444Z","az":17.452981607264242,"el":35.50693095781149},{"Time":"2023-07-09T00:01:47.3947444Z","az":17.948410778091574,"el":35.186824789497365},{"Time":"2023-07-09T00:01:48.3947444Z","az":18.433500098365474,"el":34.868502863696754},{"Time":"2023-07-09T00:01:49.3947444Z","az":18.908506849033607,"el":34.552047157825065},{"Time":"2023-07-09T00:01:50.3947444Z","az":19.373683093185477,"el":34.237532936231396},{"Time":"2023-07-09T00:01:51.3947444Z","az":19.829275578727472,"el":33.92502907506762},{"Time":"2023-07-09T00:01:52.3947444Z","az":20.27552566929373,"el":33.61459837830384},{"Time":"2023-07-09T00:01:53.3947444Z","az":20.712686706939596,"el":33.30628552481022},{"Time":"2023-07-09T00:01:54.3947444Z","az":21.140954006495168,"el":33.00016689648332},{"Time":"2023-07-09T00:01:55.3947444Z","az":21.560570364803702,"el":32.696276439755934},{"Time":"2023-07-09T00:01:56.3947444Z","az":21.971755368229328,"el":32.39465564827531},{"Time":"2023-07-09T00:01:57.3947444Z","az":22.37472319124244,"el":32.09534138420252},{"Time":"2023-07-09T00:01:58.3947444Z","az":22.76968263896796,"el":31.798366136616025},{"Time":"2023-07-09T00:01:59.3947444Z","az":23.156837201075238,"el":31.50375826998879},{"Time":"2023-07-09T00:02:00.3947444Z","az":23.536385115652624,"el":31.21154226271192},{"Time":"2023-07-09T00:02:01.3947444Z","az":23.90853426757509,"el":30.92172732452321},{"Time":"2023-07-09T00:02:02.3947444Z","az":24.273442678868054,"el":30.63435415730261},{"Time":"2023-07-09T00:02:03.3947444Z","az":24.63130841650189,"el":30.349425204769396},{"Time":"2023-07-09T00:02:04.3947444Z","az":24.982309505538144,"el":30.066951589171037},{"Time":"2023-07-09T00:02:05.3947444Z","az":25.326619144624548,"el":29.786941593365608},{"Time":"2023-07-09T00:02:06.3947444Z","az":25.6644058044141,"el":29.509400842698877},{"Time":"2023-07-09T00:02:07.3947444Z","az":25.99583332923264,"el":29.23433247768422},{"Time":"2023-07-09T00:02:08.3947444Z","az":26.321074002563943,"el":28.961726400987203},{"Time":"2023-07-09T00:02:09.3947444Z","az":26.640256562140273,"el":28.691603203809475},{"Time":"2023-07-09T00:02:10.3947444Z","az":26.95354480613065,"el":28.423948509932202},{"Time":"2023-07-09T00:02:11.3947444Z","az":27.261085117093323,"el":28.158757085687117},{"Time":"2023-07-09T00:02:12.3947444Z","az":27.563019776467808,"el":27.896021956376984},{"Time":"2023-07-09T00:02:13.3947444Z","az":27.859487070309186,"el":27.635734532634157},{"Time":"2023-07-09T00:02:14.3947444Z","az":28.15062139404285,"el":27.37788473027626},{"Time":"2023-07-09T00:02:15.3947444Z","az":28.43656475761576,"el":27.122450855518593},{"Time":"2023-07-09T00:02:16.3947444Z","az":28.717421082443273,"el":26.86944072041743},{"Time":"2023-07-09T00:02:17.3947444Z","az":28.99332531900681,"el":26.61883008560539},{"Time":"2023-07-09T00:02:18.3947444Z","az":29.26439732766024,"el":26.370603958813007},{"Time":"2023-07-09T00:02:19.3947444Z","az":29.530753584759555,"el":26.124746359516212},{"Time":"2023-07-09T00:02:20.3947444Z","az":29.79250727896795,"el":25.881240403896083},{"Time":"2023-07-09T00:02:21.3947444Z","az":30.049768405926308,"el":25.640068384632052},{"Time":"2023-07-09T00:02:22.3947444Z","az":30.302643860861238,"el":25.401211846116297},{"Time":"2023-07-09T00:02:23.3947444Z","az":30.551247446170198,"el":25.16464218349091},{"Time":"2023-07-09T00:02:24.3947444Z","az":30.795660125744703,"el":24.930358687089807},{"Time":"2023-07-09T00:02:25.3947444Z","az":31.035990115873616,"el":24.69833150037069},{"Time":"2023-07-09T00:02:26.3947444Z","az":31.272332795043,"el":24.46853984047933},{"Time":"2023-07-09T00:02:27.3947444Z","az":31.50478087327139,"el":24.24096248959629},{"Time":"2023-07-09T00:02:28.3947444Z","az":31.733424472125282,"el":24.01557784646754},{"Time":"2023-07-09T00:02:29.3947444Z","az":31.958351202617955,"el":23.792363974677656},{"Time":"2023-07-09T00:02:30.3947444Z","az":32.179655072379155,"el":23.571289796657574},{"Time":"2023-07-09T00:02:31.3947444Z","az":32.39740109224631,"el":23.352350626044082},{"Time":"2023-07-09T00:02:32.3947444Z","az":32.611678763440445,"el":23.13551484339157},{"Time":"2023-07-09T00:02:33.3947444Z","az":32.82256639108344,"el":22.920759595323535},{"Time":"2023-07-09T00:02:34.3947444Z","az":33.0301401277233,"el":22.708061891563084},{"Time":"2023-07-09T00:02:35.3947444Z","az":33.23447403868744,"el":22.497398637163847},{"Time":"2023-07-09T00:02:36.3947444Z","az":33.43564016582215,"el":22.288746662195393},{"Time":"2023-07-09T00:02:37.3947444Z","az":33.633708588969775,"el":22.08208274969747},{"Time":"2023-07-09T00:02:38.3947444Z","az":33.82875527274147,"el":21.877375464989427},{"Time":"2023-07-09T00:02:39.3947444Z","az":34.02083085857274,"el":21.674618043263393},{"Time":"2023-07-09T00:02:40.3947444Z","az":34.21000779920167,"el":21.473778998918423},{"Time":"2023-07-09T00:02:41.3947444Z","az":34.39634890605078,"el":21.27483516704253},{"Time":"2023-07-09T00:02:42.3947444Z","az":34.57991530953581,"el":21.077763447319732},{"Time":"2023-07-09T00:02:43.3947444Z","az":34.760766510071804,"el":20.882540821666687},{"Time":"2023-07-09T00:02:44.3947444Z","az":34.93896042755555,"el":20.689144370392647},{"Time":"2023-07-09T00:02:45.3947444Z","az":35.11456046228462,"el":20.497543614745318},{"Time":"2023-07-09T00:02:46.3947444Z","az":35.287607387583606,"el":20.307731291575326},{"Time":"2023-07-09T00:02:47.3947444Z","az":35.458161779433524,"el":20.119677116785816},{"Time":"2023-07-09T00:02:48.3947444Z","az":35.62627569916181,"el":19.93335870200949}],"FullPathDelta":1000000000}]}`,
		),
	)
	tracking.WithElevationMotor(elMotor)(tracker)
	tracking.WithAzimuthMotor(azMotor)(tracker)
	println("MADE TRACKER!")

	tracker.Track(context.Background())

	println("TRACKING ENDED!")
}

func getDevice(device ssd1306.Device) display.Device {
	return display.CustomDevice{
		PixelSetter: device.SetPixel,
		Displayer:   device.Display,
		Clearer:     device.ClearDisplay,
	}
}

func printGPS(printer display.Printer, ts time.Time, numSats int16, lat, lon float32, alt int32) {
	//println(fmt.Sprintf("%s lat %.2f lon %.2f alt %d sats %d",
	//	ts.Format(time.RFC1123), lat, lon, alt, numSats))
	//printer.PrintAt(
	//	0,
	//	fmt.Sprintf("%s SATS:%d",
	//		ts.Format("01/02 15:04:05"),
	//		numSats),
	//	false)
	//printer.PrintAt(
	//	1,
	//	fmt.Sprintf("LON:%.3f",
	//		lon),
	//	false)
	//printer.PrintAt(
	//	2,
	//	fmt.Sprintf("LAT:%.3f @%dM",
	//		lat,
	//		alt),
	//	false)
}

func getElevationMotor() tracking.Angler {
	dir := ElevationDirectionPin
	dir.Configure(machine.PinConfig{Mode: machine.PinOutput})
	dir.High()

	step := ElevationStepPin
	step.Configure(machine.PinConfig{Mode: machine.PinOutput})
	step.Low()

	sleep := ElevationSleepPin
	sleep.Configure(machine.PinConfig{Mode: machine.PinOutput})
	sleep.Low()

	sm := steppermotor.New(steppermotor.DeviceConfig{
		StepPin:        step,
		DirPin:         dir,
		SleepPin:       sleep,
		EnableSleeping: false,
		StepCount:      200,
		RPM:            40,
	}, false)

	return motors.New(sm, 15)
}

func getAzimuthMotor() tracking.Angler {
	dir := AzimuthDirectionPin
	dir.Configure(machine.PinConfig{Mode: machine.PinOutput})
	dir.High()

	step := AzimuthStepPin
	step.Configure(machine.PinConfig{Mode: machine.PinOutput})
	step.Low()

	sleep := AzimuthSleepPin
	sleep.Configure(machine.PinConfig{Mode: machine.PinOutput})
	sleep.Low()

	sm := steppermotor.New(steppermotor.DeviceConfig{
		StepPin:        step,
		DirPin:         dir,
		SleepPin:       sleep,
		EnableSleeping: false,
		StepCount:      200,
		RPM:            60,
	}, false)
	return motors.New(sm, 0)
}
